&lt;body&gt;
&lt;font face=&quot;arial,helvetica&quot;&gt;
&lt;font size=+3&gt;&lt;code&gt;&amp;lt;CANVAS&amp;gt;&lt;/code&gt; fuzzer&lt;/font&gt;&lt;font size=-1&gt; by &lt;a href=&quot;mailto:lcamtuf@coredump.cx&quot;&gt;lcamtuf@coredump.cx&lt;/a&gt;&lt;/font&gt;&lt;p&gt;

&lt;div id=ccont&gt;
&lt;canvas id=canvas height=200 width=300 style=&quot;border: 1px solid teal&quot;&gt;&lt;/canvas&gt;
&lt;/div&gt;
&lt;img id=image src=&quot;envelope.gif&quot; align=top&gt;
&lt;p&gt;

&lt;input type=checkbox id=dealloc&gt; Deallocate canvas after every cycle (NULL ptr in Safari, likely exploitable in Opera)&lt;br&gt;
&lt;input type=checkbox id=keep_ctx&gt; Keep context (if combined with above, NULL ptr Firefox, likely exploitable in Opera)&lt;br&gt;
&lt;input type=checkbox id=scale_large&gt; Use large canvas scaling (likely exploitable in Opera, bogs down Firefox)&lt;br&gt;
&lt;input type=checkbox id=return_undef&gt; Return &lt;code&gt;undefined&lt;/code&gt; values (NULL ptr Safari, may hang Opera)&lt;br&gt;
&lt;input type=checkbox id=return_large&gt; Return large integers (exploitable crash in Safari, OOM/DoS elsewhere)&lt;br&gt;
&lt;input type=checkbox id=quick&gt; Skip time-consuming operations (quicker, but may miss issues)&lt;p&gt;

&lt;input type=submit value=&quot;Begin tests&quot; id=button onclick=&quot;setup_all()&quot;&gt;&lt;p&gt;

&lt;script&gt;
var ctx;		/* Canvas context  */
var imgObj;		/* Reference image */
var scval = 1;
var transval = 0;

var quick;
var dealloc;
var return_undef;
var return_large;
var scale_large;
var keep_ctx;
var iht;

function setup_all() {
  var canvas = document.getElementById(&#039;canvas&#039;);
  ctx = canvas.getContext(&#039;2d&#039;);
  imgObj = document.getElementById(&#039;image&#039;);

  iht = document.getElementById(&#039;ccont&#039;).innerHTML;

  quick = document.getElementById(&#039;quick&#039;).checked;
  dealloc = document.getElementById(&#039;dealloc&#039;).checked;
  return_undef = document.getElementById(&#039;return_undef&#039;).checked;
  return_large = document.getElementById(&#039;return_large&#039;).checked;
  scale_large  = document.getElementById(&#039;scale_large&#039;).checked;
  keep_ctx  = document.getElementById(&#039;keep_ctx&#039;).checked;
  document.getElementById(&#039;button&#039;).disabled = true;

  setInterval(&#039;do_fuzz();&#039;,1);

}
  


function R(x) {
  return Math.floor(Math.random() * x);
}


function make_number() {
  var v;
  var sel;

  if (return_large == true &amp;&amp; R(3) == 1) sel = R(6); else  sel = R(4);
  if (return_undef == false &amp;&amp; sel == 0) sel = 1;

  if (R(2) == 1) v = R(100); else

  switch (sel) {
    case 0: break; 
    case 1: v = 0; break;
    case 2: v = 0.000001; break;
    case 3: v = 10000; break;
    case 4: v = 2000000000; break;
    case 5: v = 1e100; break;
  }

  if (R(4) == 1) v = -v;
  return v;

}


function make_color() {
  if (R(2) == 1) return &quot;#C0F0A0&quot;; else return &quot;#000090&quot;;
}


function make_fill() {


  var sel;

  if (quick == true) sel = 0; else sel = R(6);

  switch (sel) {
 
    case 0:
    case 1:
    case 2:
      return make_color();
      break;

    case 3:
      var r = ctx.createLinearGradient(make_number(),make_number(),make_number(),make_number());
      for (i=0;i&lt;4;i++)
        r.addColorStop(make_number(),make_color());
      return r;
      break;

    case 4:
      var r = ctx.createRadialGradient(make_number(),make_number(),make_number(),make_number(),make_number(),make_number());
      for (i=0;i&lt;4;i++)
        r.addColorStop(make_number(),make_color());
      return r;
      break;

    case 5:
      var r = ctx.createPattern(imgObj,&quot;repeat&quot;);
      if (R(6) == 0)
        r.addColorStop(make_number(),make_color());
      return r;
      break;
  }

}
    

function do_fuzz() {

  if (dealloc == true)
    document.getElementById(&#039;ccont&#039;).innerHTML = iht;

  if (keep_ctx == false) {
    var canvas = document.getElementById(&#039;canvas&#039;);
    ctx = canvas.getContext(&#039;2d&#039;);
  }


  for (i=0;i&lt;100;i++) {
    try {

  switch (R(33)) {

    case 0:
      ctx.fillStyle = make_fill();
      break;

    case 1:
      ctx.globalAlpha = Math.random() - .5;
      break;

    case 2:
      switch (R(3)) {
        case 0: ctx.globalCompositeOperation = &#039;copy&#039;; break;
        case 1: ctx.globalCompositeOperation = &#039;xor&#039;; break;
        case 2: ctx.globalCompositeOperation = &#039;source-over&#039;; break;
      }      
      break;

    case 3:
      switch (R(2)) {
        case 0: ctx.lineCap = &#039;round&#039;; break;
        case 1: ctx.lineCap = &#039;butt&#039;; break;
      }      
      break;

    case 4:
      switch (R(2)) {
        case 0: ctx.lineJoin = &#039;round&#039;; break;
        case 1: ctx.lineJoin = &#039;miter&#039;; break;
      }      
      break;

    case 5: 
      ctx.lineWidth = make_number(); 
      break;

    case 6: 
      ctx.miterLimit = make_number();
      break;

    case 7: 
      if (quick == true) break;
      ctx.shadowBlur = make_number(); 
      break;

    case 8: 
      if (quick == true) break;
      ctx.shadowColor = make_fill(); 
      break;

    case 9: 
      if (quick == true) break;
      ctx.shadowOffsetX = make_number();
      ctx.shadowOffsetY = make_number();
      break;

    case 10:
      ctx.restore();
      break;

    case 11:
      ctx.rotate(make_number());
      break;

    case 12:
      ctx.save();
      break;

    case 13:
      ctx.scale(-1,-1);
      break;

    case 14:

      if (quick == true) break;

      if (transval == 0) {
        transval = make_number();
        ctx.translate(transval,0);
      } else {
        ctx.translate(-transval,0);
        transval = 0;
      }

      break;

    case 15:
      ctx.clearRect(make_number(),make_number(),make_number(),make_number());
      break;

    case 16:
      if (quick == true) break;
      ctx.drawImage(imgObj,make_number(),make_number(),make_number(),make_number(),make_number(),make_number(),make_number(),make_number());
      break;

    case 17:
      ctx.fillRect(make_number(),make_number(),make_number(),make_number());
      break;

    case 18:
      ctx.beginPath();
      break;

    case 19:
      // ctx.clip() is evil.
      break;

    case 20:
      ctx.closePath();
      break;

    case 21:
      ctx.fill();
      break;

    case 22:
      ctx.stroke();
      break;

    case 23:
      ctx.strokeRect(make_number(),make_number(),make_number(),make_number());
      break;

    case 24:
      if (quick == true) break;
      ctx.arc(make_number(),make_number(),make_number(),make_number(),make_number(),true);
      break;

    case 25:
      if (quick == true) break;
      ctx.arcTo(make_number(),make_number(),make_number(),make_number(),make_number());
      break;

    case 26:
      if (quick == true) break;
      ctx.bezierCurveTo(make_number(),make_number(),make_number(),make_number(),make_number(),make_number());
      break;

    case 27:
      ctx.lineTo(make_number(),make_number());
      break;

    case 28:
      ctx.moveTo(make_number(),make_number());
      break;

    case 29:
      if (quick == true) break;
      ctx.quadraticCurveTo(make_number(),make_number(),make_number(),make_number());
      break;

    case 30:
      if (quick == true) break;
      ctx.transform(make_number(),make_number(),make_number(),make_number(),make_number(),make_number());
      break;

    case 31:
      if (quick == true) break;
      ctx.setTransform(make_number(),make_number(),make_number(),make_number(),make_number(),make_number());
      break;

    case 32:

      if (scale_large == true) {

        switch (scval) {
          case 0: ctx.scale(-1000000000,1); 
                  ctx.scale(-1000000000,1);
                  scval = 1; break;
          case 1: ctx.scale(-.000000001,1); scval = 2; break;
          case 1: ctx.scale(-.000000001,1); scval = 0; break;
        }

      }

      break;



  }

    } catch (e) { }

  }

}

&lt;/script&gt;
